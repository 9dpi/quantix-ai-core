<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantix Lab | Quantix AI Core</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="../static/img/favicon.svg">
    <style>
        /* Bento Layout Enhancements */
        .lab-bento-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* EQUAL WIDTH implicitly helps, but user asked for Equal Length/Height */
            gap: 32px;
            margin-top: 40px;
            align-items: stretch;
            /* Default, but explicit */
        }

        .reasoning-box,
        .reference-card-bento {
            height: 100%;
            /* Force equal height */
            display: flex;
            flex-direction: column;
        }

        /* ... existing styles ... */

        .bento-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .select-bar {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 40px;
        }

        .select-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr 1.2fr;
            gap: 20px;
            align-items: flex-end;
        }

        /* Input Styling */
        .lab-input {
            width: 100%;
            background: #000;
            color: #fff;
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s;
        }

        .lab-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        /* Fix Calendar Icon Color - Invert to White */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .label-tiny {
            display: block;
            font-size: 0.65rem;
            color: var(--accent);
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }

        .reasoning-box {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            padding: 40px;
            border-radius: 20px;
            height: 100%;
        }

        .reference-card-bento {
            background: var(--bg-sub);
            border: 1px solid var(--border);
            padding: 32px;
            border-radius: 20px;
            position: relative;
        }

        @media (max-width: 992px) {
            .lab-bento-grid {
                grid-template-columns: 1fr;
            }

            .select-grid {
                grid-template-columns: 1fr 1fr;
            }

            .btn-run-wrap {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 600px) {
            .select-grid {
                grid-template-columns: 1fr;
            }

            .signals-header h1 {
                font-size: 2rem !important;
            }

            .reasoning-box {
                padding: 24px;
            }
        }
    </style>
</head>

<body class="scrollable-page">
    <header class="app-header">
        <div class="logo-area">
            <div class="logo-icon"></div>
            <span class="logo-text">QUANTIX AI CORE</span>
        </div>
        <div class="hamburger" id="menu-toggle">‚ò∞</div>
        <nav class="main-nav" id="main-nav">
            <a href="../" class="nav-link">Overview</a>
            <a href="../dashboard/" class="nav-link">Live System</a>
            <a href="../signals/" class="nav-link">Market Reference</a>
            <a href="../lab/" class="nav-link active">Quantix Lab</a>
            <a href="../api/" class="nav-link">API</a>
            <a href="../disclaimer/" class="nav-link">Legal</a>
        </nav>
        <div class="status-tag hide-mobile"
            style="width: 240px; display: flex; justify-content: flex-end; font-size: 0.7rem; color: var(--text-dim); align-items: center; gap: 8px;">
            <div class="dot dot-online"></div> LAB_EXPLORER_ACTIVE
        </div>
    </header>

    <main class="content-container">
        <!-- TOP CONTEXT BANNER -->
        <div
            style="background: rgba(56, 189, 248, 0.05); border: 1px solid rgba(56, 189, 248, 0.2); padding: 12px; border-radius: 100px; margin-bottom: 40px; text-align: center; max-width: 600px; margin-left: auto; margin-right: auto;">
            <span style="font-size: 0.75rem; color: var(--text-dim);">üß™ <strong>Quantix Lab</strong> ‚Äî Explore how AI
                interpreted the market at any given timestamp.</span>
        </div>

        <div class="signals-header" style="margin-bottom: 60px;">
            <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 12px; letter-spacing: -0.03em;">
                Quantix Lab ‚Äì Market Reasoning Snapshot
            </h1>
            <p
                style="color: var(--accent); font-weight: 700; font-size: 1.1rem; letter-spacing: 0.1em; text-transform: uppercase;">
                Forensic Market Analysis Explorer</p>
        </div>

        <!-- SELECTOR BAR (BENTO STYLE) -->
        <div class="select-bar">
            <!-- ... (inputs remain same) ... -->
            <div class="select-grid">
                <div>
                    <label class="label-tiny">ASSET</label>
                    <select id="lab-asset" class="lab-input">
                        <option value="EURUSD">EUR/USD</option>
                        <option value="GBPUSD">GBP/USD</option>
                        <option value="USDJPY">USD/JPY</option>
                        <option value="AUDUSD">AUD/USD</option>
                    </select>
                </div>
                <div>
                    <label class="label-tiny">TIMEFRAME</label>
                    <select id="lab-tf" class="lab-input">
                        <option value="M15">M15</option>
                        <option value="H1">H1</option>
                        <option value="H4">H4</option>
                    </select>
                </div>
                <div>
                    <label class="label-tiny">REFERENCE POINT (UTC)</label>
                    <input type="datetime-local" id="lab-time" class="lab-input">
                </div>
                <div class="btn-run-wrap">
                    <button onclick="runLabReasoning()" class="btn-analyze btn-bright"
                        style="width: 100%; height: 46px; border-radius: 8px; font-weight: 800; font-size: 0.8rem; box-shadow: 0 4px 20px rgba(56, 189, 248, 0.2);">
                        GENERATE SNAPSHOT
                    </button>
                </div>
            </div>
            <p style="text-align: center; color: var(--text-dim); font-size: 0.65rem; margin-top: 16px; opacity: 0.8;">
                ‚ÑπÔ∏è System generates a deterministic snapshot for the specified timestamp.
            </p>
        </div>

        <!-- BENTO GRID OUTPUT -->
        <div id="lab-output-area" style="display: none;">
            <div class="lab-bento-grid">
                <!-- REASONING SNAPSHOT -->
                <div>
                    <div class="bento-header" style="color: #ff4785;">
                        <span
                            style="font-size: 12px; border-radius: 50%; background: #ff4785; width: 8px; height: 8px; display: inline-block;"></span>
                        REASONING OUTPUT
                    </div>
                    <div class="reasoning-box">
                        <div style="margin-bottom: 32px;">
                            <div class="label-tiny">STRUCTURE STATE</div>
                            <div id="res-state"
                                style="font-size: 1.8rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.01em;">
                                ‚Äî
                            </div>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <div class="label-tiny" style="margin-bottom: 16px;">EVIDENCE</div>
                            <ul id="res-evidence"
                                style="list-style: none; padding: 0; display: flex; flex-direction: column; gap: 12px;">
                                <!-- Dynamic List -->
                            </ul>
                        </div>

                        <div>
                            <div class="label-tiny" style="color: #ef4444; margin-bottom: 12px;">INVALIDATION LOGIC
                            </div>
                            <div id="res-invalidation"
                                style="color: var(--text-dim); font-size: 0.85rem; line-height: 1.5; border-left: 2px solid #ef4444; padding-left: 12px;">
                                ‚Äî
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SNAPSHOT INFO PANEL -->
                <div>
                    <div class="bento-header">
                        <span style="font-size: 1rem;">üßæ</span> SNAPSHOT INFO MODEL
                    </div>

                    <div class="reference-card-bento">
                        <!-- Details Panel -->
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 0.8rem; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 24px;">
                            <div>
                                <div class="label-tiny">SYMBOL</div>
                                <div id="info-symbol" style="color: var(--text-main); font-weight: 700;">‚Äî</div>
                            </div>
                            <div>
                                <div class="label-tiny">TIMEFRAME</div>
                                <div id="info-tf" style="color: var(--text-main); font-weight: 700;">‚Äî</div>
                            </div>
                            <div style="grid-column: 1/-1;">
                                <div class="label-tiny">GENERATED AT (UTC)</div>
                                <div id="info-generated"
                                    style="color: var(--text-dim); font-family: 'JetBrains Mono'; letter-spacing: -0.05em;">
                                    ‚Äî</div>
                            </div>
                            <div>
                                <div class="label-tiny">AGE</div>
                                <div id="info-age" style="color: var(--accent);">‚Äî</div>
                            </div>
                            <div>
                                <div class="label-tiny">PROVIDER</div>
                                <div id="info-provider" style="color: var(--text-main);">DUKASCOPY</div>
                            </div>
                            <div style="grid-column: 1/-1;">
                                <div class="label-tiny">TRACE ID</div>
                                <div id="info-trace"
                                    style="font-family: 'JetBrains Mono'; font-size: 0.7rem; color: var(--text-dim); word-break: break-all;">
                                    ‚Äî</div>
                            </div>
                        </div>

                        <!-- Confidence & Bias Small View -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="label-tiny">CONFIDENCE</div>
                                <div id="info-confidence"
                                    style="font-size: 1.2rem; font-weight: 800; color: var(--highlight);">‚Äî</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="label-tiny">BIAS</div>
                                <div id="info-bias" style="font-size: 1rem; font-weight: 700; color: var(--text-main);">
                                    ‚Äî</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="app-footer-grid">
            <div class="footer-block">
                <h4>Quantix AI Core ‚Äì Explainable Market Reasoning Engine (Snapshot Mode)</h4>
                <p>This interface displays historical, static reasoning snapshots generated by Quantix AI Core for
                    research, evaluation, and integration purposes.</p>
            </div>
            <div class="footer-block">
                <h4>Non-Predictive / Non-Actionable</h4>
                <p>All outputs are non-predictive, non-actionable, and provided ‚Äúas is‚Äù. This system does not provide
                    financial advice, investment recommendations, or trading signals. Users are solely responsible for
                    any decisions made using this information.</p>
            </div>
            <div class="footer-block">
                <h4>Transparency Notice</h4>
                <p>Reasoning snapshots are generated from frozen historical market data at a specific reference
                    timestamp. No future data is accessed. No look-ahead bias is applied.</p>
            </div>
            <div class="footer-block">
                <h4>Engine Meta</h4>
                <p>Engine Version: Quantix-Core v0.9 (Lab)<br>Reasoning Type: Structure-Based, Rule-Driven AI<br>¬© 2026
                    Quantix AI Core ‚Äî All rights reserved.</p>
            </div>
        </footer>

        <script src="../static/js/api.js"></script> <!-- Ensure we have API Config -->
        <script>
            // Set default time to now for convenience (UTC)
            window.onload = () => {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('lab-time').value = now.toISOString().slice(0, 16);
            };

            async function runLabReasoning() {
                const asset = document.getElementById('lab-asset').value;
                const tf = document.getElementById('lab-tf').value;
                let timeStr = document.getElementById('lab-time').value; // Local input time

                if (!timeStr) {
                    alert("Please specify a timestamp.");
                    return;
                }

                // Convert to strict ISO-8601 string for backend (append :00Z if needed, though backend just treats string as seed)
                // Just assume input is intended as UTC for simplicity in this lab tool

                const btn = document.querySelector('.btn-analyze');
                const originalText = btn.innerText;
                btn.innerText = "‚è≥ COMPUTING...";
                btn.disabled = true;

                try {
                    const baseUrl = typeof API_CONFIG !== 'undefined' ? API_CONFIG.BASE_URL : 'https://quantixaicore-production.up.railway.app/api/v1';

                    // Fetch from API with snap_time
                    const response = await fetch(`${baseUrl}/lab/market-reference?symbol=${asset}&tf=${tf}&snap_time=${encodeURIComponent(timeStr)}&_=${Date.now()}`);

                    if (!response.ok) throw new Error("API Connection Failed");

                    const data = await response.json();
                    renderLabOutput(data);

                    document.getElementById('lab-output-area').style.display = 'block';
                    window.scrollTo({
                        top: document.getElementById('lab-output-area').offsetTop - 100,
                        behavior: 'smooth'
                    });

                } catch (e) {
                    console.error(e);
                    alert("Lab Engine Offline or Error: " + e.message);
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }

            function renderLabOutput(data) {
                // 1. Reasoning Output
                const reasoning = data.reasoning || {};
                document.getElementById('res-state').innerText = reasoning.state || "UNKNOWN";
                document.getElementById('res-state').style.color = data.ui_color === 'red' || data.ui_color === 'fire' ? '#ef4444' : (data.ui_color === 'green' ? 'var(--highlight)' : 'var(--text-main)');

                const evidenceList = document.getElementById('res-evidence');
                evidenceList.innerHTML = '';
                (reasoning.evidence || []).forEach(item => {
                    const li = document.createElement('li');
                    li.style.cssText = "display: flex; gap: 12px; color: var(--text-dim); font-size: 0.9rem;";
                    li.innerHTML = `<span style="color: var(--highlight);">‚úî</span> ${item.replace('‚úî', '').trim()}`; // Clean double ticks if any
                    evidenceList.appendChild(li);
                });

                document.getElementById('res-invalidation').innerHTML =
                    `Reference snapshot is invalid if price breaks ${reasoning.invalidation_price ? 'beyond' : ''} <span style="font-family: 'JetBrains Mono'; color: #ef4444; font-weight: 700;">${reasoning.invalidation_price || 'N/A'}</span>`;

                // 2. Snapshot Info Panel
                document.getElementById('info-symbol').innerText = data.asset;
                document.getElementById('info-tf').innerText = data.timeframe;
                document.getElementById('info-generated').innerText = data.meta.generated_at;
                document.getElementById('info-trace').innerText = reasoning.trace_id || "N/A";
                document.getElementById('info-confidence').innerText = (data.confidence * 100).toFixed(0) + "% ‚≠ê";
                document.getElementById('info-bias').innerText = data.trade_bias;
                document.getElementById('info-provider').innerText = reasoning.provider || "DUKASCOPY";

                // Calculate Age
                const genTime = new Date(data.meta.generated_at);
                const now = new Date(); // Browser local time, but generated_at should be parsed correctly as UTC if format is ISO
                // Assuming simplified diff for Lab demo
                // In historical mode, "Age" might be "Historical"

                if (data.meta.is_historical) {
                    document.getElementById('info-age').innerText = "HISTORICAL ARCHIVE";
                } else {
                    const diffMins = Math.round((Date.now() - genTime.getTime()) / 60000);
                    document.getElementById('info-age').innerText = `${diffMins} mins ago`;
                }
            }
        </script>
        <script src="../static/js/ui_shared.js"></script>
</body>

</html>