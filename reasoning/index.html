<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reasoning Engine | Quantix AI Core</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="../static/img/favicon.png">
    <style>
        .control-panel {
            background: var(--bg-sub);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            font-weight: 700;
        }

        select,
        input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .btn-analyze {
            background: var(--accent);
            color: var(--bg-main);
            border: none;
            padding: 12px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 0.8rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-analyze:hover {
            opacity: 0.9;
        }

        .evidence-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            font-size: 0.8rem;
            margin-bottom: 8px;
            display: flex;
            gap: 10px;
        }

        .state-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
        }

        .state-badge.bullish {
            background: rgba(16, 185, 129, 0.1);
            color: var(--highlight);
        }

        .state-badge.bearish {
            background: rgba(244, 63, 94, 0.1);
            color: var(--warning);
        }
    </style>
</head>

<body class="scrollable-page">
    <header class="app-header">
        <div class="logo-area">
            <div class="logo-icon"></div>
            <span class="logo-text">QUANTIX AI CORE</span>
        </div>
        <div class="hamburger" id="menu-toggle">‚ò∞</div>
        <nav class="main-nav" id="main-nav">
            <a href="../" class="nav-link">About</a>
            <a href="../dashboard/" class="nav-link">Dashboard</a>
            <a href="../signals/" class="nav-link">Signals</a>
            <a href="../reasoning/" class="nav-link active">Reasoning</a>
            <a href="../api/" class="nav-link">API</a>
            <a href="../disclaimer/" class="nav-link">Legal</a>
        </nav>
        <div class="status-tag hide-mobile"
            style="width: 240px; display: flex; justify-content: flex-end; font-size: 0.7rem; color: var(--text-dim); align-items: center; gap: 8px;">
            <div class="dot dot-online"></div> REASONING_ACTIVE
        </div>
    </header>

    <main class="app-layout">
        <!-- LEFT: CONTROLS -->
        <aside class="column left-col">
            <h2 class="section-title">Resolver Controls</h2>
            <div class="control-panel">
                <div class="form-group">
                    <label>Symbol</label>
                    <input type="text" id="symbol" value="EURUSD">
                </div>
                <div class="form-group">
                    <label>Timeframe</label>
                    <select id="timeframe">
                        <option value="H1">H1 (Hourly)</option>
                        <option value="H4" selected>H4 (4-Hour)</option>
                        <option value="D1">D1 (Daily)</option>
                    </select>
                </div>
                <button class="btn-analyze" onclick="analyzeMarket()">RUN RESOLVER</button>
            </div>

            <div class="why-box" style="margin-top: 24px; padding: 16px;">
                <div class="why-title" style="font-size: 0.7rem;">üõ°Ô∏è Data Law</div>
                <div class="why-content" style="font-size: 0.7rem; color: var(--text-dim);">Resolver ignores all price
                    spikes outside of 1ms latency tolerance.</div>
            </div>
        </aside>

        <!-- MIDDLE: RESULTS -->
        <section class="column middle-col">
            <h2 class="section-title">Market Structure Analysis</h2>
            <div id="results">
                <div style="padding: 40px; text-align: center; color: var(--text-dim);">Ready for analysis. Select
                    symbol and run resolver.</div>
            </div>
        </section>

        <!-- RIGHT: AUDIT & LAB -->
        <aside class="column right-col">
            <h2 class="section-title">Analysis Trace</h2>
            <div id="trace-panel">
                <div class="data-card" style="font-size: 0.75rem; color: var(--text-dim); border-style: dashed;">
                    Awaiting generation...
                </div>
            </div>

            <div id="lab-section" style="margin-top: 32px; display: none;">
                <h2 class="section-title">Lab Decision Support</h2>
                <div id="lab-result"></div>
            </div>
        </aside>
    </main>

    <footer class="app-footer">
        <div class="disclaimer"><strong>LEGAL SHIELD:</strong> Deterministic market analysis. Not a trading signal.
        </div>
    </footer>

    <script>
        const API_BASE = 'https://quantixaicore-production.up.railway.app/api/v1';

        async function analyzeMarket() {
            const symbol = document.getElementById('symbol').value;
            const timeframe = document.getElementById('timeframe').value;
            const resultsDiv = document.getElementById('results');
            const tracePanel = document.getElementById('trace-panel');

            resultsDiv.innerHTML = '<div style="padding: 60px; text-align: center; color: var(--accent);">üîÑ Resolving structure...</div>';

            try {
                const response = await fetch(`${API_BASE}/internal/feature-state/structure?symbol=${symbol}&tf=${timeframe}`);
                if (!response.ok) throw new Error("API Connection Failed");
                const data = await response.json();
                renderResults(data);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="data-card" style="color: var(--warning); border-color: var(--warning);">Error: ${error.message}</div>`;
            }
        }

        function renderResults(data) {
            const resultsDiv = document.getElementById('results');
            const tracePanel = document.getElementById('trace-panel');
            const state = data.state || 'unknown';
            const confidence = (data.confidence || 0) * 100;
            const dominance = data.dominance || { bullish: 0, bearish: 0 };
            const evidence = data.evidence || [];

            resultsDiv.innerHTML = `
                <div class="snapshot-card" style="background: var(--bg-sub); border: 1px solid var(--border); margin-top: 0;">
                    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="font-size: 1.5rem; font-weight: 800;">${data.symbol} <span style="font-weight: 400; color: var(--text-dim);">${data.timeframe}</span></div>
                        <div class="state-badge ${state}">${state.toUpperCase()}</div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display:flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 8px;">
                            <span>Structural Confidence</span>
                            <span>${confidence.toFixed(1)}%</span>
                        </div>
                        <div style="height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden;">
                            <div style="width: ${confidence}%; height: 100%; background: var(--accent); transition: width 0.5s;"></div>
                        </div>
                    </div>

                    <h3 class="section-title" style="margin-top: 32px; font-size: 0.6rem;">üß© Logically Resolved Evidence</h3>
                    <div style="margin-top: 12px;">
                        ${evidence.map(ev => `<div class="evidence-item"><span>‚óà</span> <span>${ev}</span></div>`).join('')}
                    </div>
                </div>
                
                <div class="data-card" style="margin-top: 24px;">
                    <div class="section-title" style="font-size: 0.6rem;">üìä Directional Dominance</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div>
                            <div class="label">BULLISH SCORE</div>
                            <div class="value" style="color: var(--highlight);">${dominance.bullish.toFixed(2)}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="label">BEARISH SCORE</div>
                            <div class="value" style="color: var(--warning);">${dominance.bearish.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;

            tracePanel.innerHTML = `
                <div class="snapshot-card" style="padding: 16px; margin-top: 0;">
                    <div class="label">Trace ID</div>
                    <div class="value" style="font-size: 0.7rem; color: var(--text-main); word-break: break-all;">${data.trace_id}</div>
                    <div style="margin-top: 12px;">
                        <div class="label">Method</div>
                        <div style="font-size: 0.7rem; color: var(--text-main);">Deterministic Structure Resolver</div>
                    </div>
                </div>
            `;

            if (data.show_lab_signals) {
                document.getElementById('lab-section').style.display = 'block';
                const labDecision = (state === 'bullish' && confidence >= 88) ? 'BUY_CANDIDATE' : (state === 'bearish' && confidence >= 88) ? 'SELL_CANDIDATE' : 'NO_ACTION';
                document.getElementById('lab-result').innerHTML = `
                    <div class="snapshot-card" style="background: rgba(56, 189, 248, 0.03); border: 1px solid rgba(56, 189, 248, 0.15); margin-top: 0;">
                        <div style="font-size: 1rem; font-weight: 800; color: var(--accent);">${labDecision}</div>
                        <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 8px;">Experimental decision support for research only.</div>
                    </div>
                `;
            }
        }
    </script>
    <script src="../static/js/ui_shared.js"></script>
</body>

</html>